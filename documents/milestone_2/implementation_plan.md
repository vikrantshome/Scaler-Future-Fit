# Milestone 2: Offline Data Integration & Admin Portal

## Goal
To integrate offline OMR data (CSV) into the main `Scaler Future Fit` system, process it to generate career reports, and allow bulk export of results with public links.

## 1. Feature Analysis

### A. Inputs
- **Source**: CSV file generated by OMR Scanner (`omr-scannner/data/output/*.csv`).
- **Format**:
    - **Personal**: `student_id`, `full_name`, `date_of_birth`, etc.
    - **RAISEC (Q1-Q12)**: Scores 1-5.
    - **Academic (Q13-Q17)**: Options A-E.

### B. Outputs
1.  **System Database**: Student profiles saved in MongoDB.
2.  **Public Links**: Access to reports via `http://.../report/<student_id>`.
3.  **Summary CSV**: A downloadable file containing:
    - Student Details
    - Top 3 Career Matches
    - Specific Qualitative Answers (Q13, Q14, Q16, Q17)
    - Public Report Link

---

## 2. Technical Implementation

### A. Data Mapping Strategy
We must map OMR options (A, B, C...) to the System Values expected by `scoringService.ts`.

| OMR Question | CSV Column | System Field `academic` | Mapping (A/B/C/D/E) |
| :--- | :--- | :--- | :--- |
| **Q1-Q12** | `q1`...`q12` | `raisec.r1`...`c2` | Direct Value (1-5). **Default to 3** if empty or `-`. |
| **Q13** (Fav Subj) | `q13` | `favoriteSubject` | A:Math, B:Physics, C:CS, D:Chem, E:Bio |
| **Q14** (Strong Subj)| `q14` | `strongestSubject`| A:Math, B:Physics, C:CS, D:Chem, E:Bio |
| **Q15** (Learning) | `q15` | `learningStyle` | A:Practical, B:Theoretical, C:Rote |
| **Q16** (Exams) | `q16` | `examPrep` | A:JEE, B:BITSAT, C:CET, D:Olympiad, E:None |
| **Q17** (Goal) | `q17` | `engineeringGoal` | A:Software, B:Research, C:Startup, D:Core |

*(Note: These mappings are derived from `constants.ts` order. We will create a utility helper to enforce this).*

### B. Backend Changes (`server/`)

#### 1. New API: Bulk Upload
- **Endpoint**: `POST /api/admin/bulk-upload`
- **Body**: Array of `StudentProfile` objects (mapped from CSV).
- **Logic**:
    - Iterate through records.
    - Upsert by `student_id` (or `personalInfo.phone` fallback).
    - Calculate Results (if not passed).
    - Save to DB.
    - Return list of `{ id, student_id, name, success }`.

#### 2. New API: Get Student Public
- **Endpoint**: `GET /api/student/:id`
- **Logic**: Fetch student by ID (publicly accessible, or secured by specific query param/token if needed, but requirements imply public link).

### C. Frontend Changes (`App.tsx` & Components)

#### 1. Admin Portal Component
- **Path**: `/admin/upload` (or protected route).
- **UI**:
    - File Upload (CSV).
    - "Processing..." Progress Bar.
    - Results Summary (Processed X/Y).
    - **"Download Summary CSV"** Button.

#### 2. Public Report Component
- **Path**: `/report/:studentId`
- **Logic**:
    - Fetch data from `GET /api/student/:id`.
    - Render `ResultsView` in "Read Only" mode.
    - Header should show "Report for <Name>" instead of "Welcome".

#### 3. Summary CSV Generator
- **Trigger**: Post-upload in Admin Portal.
- **Columns**:
    - `Student ID`, `Name`, `Mobile`, `Email`, `Grade`, `School`, `City`, `Date`
    - `Top Career 1`, `Top Career 2`, `Top Career 3`
    - `Favorite Subject`, `Strongest Subject`, `Exam Prep`, `Career Goal`
    - `Report Link` (e.g., `https://futurefit.scaler.com/report/<id>`)

---

## 3. Step-by-Step Plan

### Phase 1: Backend API
1.  [ ] Create `POST /api/admin/bulk-upload` in `server/index.js`.
2.  [ ] Create `GET /api/student/:id` in `server/index.js`.

### Phase 2: Frontend Admin
3.  [ ] Create `src/services/csvMapping.ts` to map OMR codes to System values.
4.  [ ] Create `src/components/AdminPortal.tsx` to handle file upload and API calls.
5.  [ ] Add logic to generate the "Summary CSV" using `PapaParse`.

### Phase 3: Public Report
6.  [ ] Create `src/components/PublicReport.tsx`.
7.  [ ] Update `App.tsx` to handle routing (Note: App currently uses `AppState`. We might need to check URL params on load to switch state to `RESULTS` with fetched data).

---

## 4. Immediate Next Step
- Create the Mapping Utility and Admin Component.
